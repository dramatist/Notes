### IoC容器职责

* 依赖处理
    * 依赖查找
    * 依赖注入

* 生命周期管理
    * 容器
    * 托管的资源
* 配置管理
    * 容器
    * 托管的资源
    * 外部化配置

### ApplicationContext启动流程

AbstractApplicationContext#refresh

* prepareRefresh

    * 启动时间 startupDate
    * 状态标识 closed--false  active--true

    * initPropertySources

    * 校验Environment必要属性
    * 初始化事件监听器集合
    * 初始化早期事件集合

* obtainFreshBeanFactory
    * 刷新底层BeanFactory，refreshBeanFactory
        * 销毁或关闭BeanFactory，如果存在的话
        * 创建BeanFactory，createBeanFacoty
        * 设置id
        * 设置是否允许BeanDefinition覆盖，customizeBeanFactory
        * 设置是否允许循环引用，customizeBeanFactory
        * 加载BeanDefinition，loadBeanDefinitions
        * 关联BeanFactory到ApplicationContext
    * 返回底层BeanFactory，getBeanFactory

* prepareBeanFactory
    * 关联ApplicationContext的ClassLoader
    * 设置Spel表达式处理器
    * 添加PropertyEditorRegistrar，ResourceEditorREgistrar
    * 添加ApplicationContextAwarePostProcessor
    * ignoreDependencyInterface，忽略Aware接口
    * 注册resolvableDependency，BeanFactory、ResourceLoader、ApplicationEventPublisher、ApplicationContext
    * 注册ApplicationListenerDector，BeanPostProcessor实现类
    * 注册LoadTimeWeaverAwareProcessor
    * 注册单例对象，Environment、SystemProperties、SystemEnvironment
* postProcessBeanFactory，由子类扩展
* invokeBeanFactoryPostProcessors
    * PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors
* registerBeanPostProcessors
    * PostProcessorRegistrationDelegate#registerBeanPostProcessors
    * 注册PriorityOrdered类型的BeanPostProcessors
    * 注册Ordered类型的BeanPostProcessors
    * 注册普通BeanPostProcessors
    * 注册MergedBeanDefinitionPostProcessors
    * 注册ApplicationListenerDector
* initMessageSource
* initApplicationEventMulticaster
* onRefresh，由子类扩展
* registerListeners
    * 为ApplicationEventMulticaster注册ApplicatonListener
    * 广播早期Spring事件
* finishBeanFactoryInitialization
    * 关联ConversionService
    * 添加StringValueResolver
    * 依赖查找LoadTimeWeaverAware
    * BeanFacoty临时ClassLoader设置为null
    * BeanFacoty冻结配置
    * 初始化非延迟单例Bean
* finishRefresh
    * 清除ResourceLoader缓存
    * 初始化LifecycleProcessor对象，initLifecycleProcessor
    * 调用LifecycleProcessor的onRefresh
    * 发布ContextRefreshedEvent
    * MBean注册

AbstractApplication#start

* 调用LifecycleProcessor的start方法
* 发布ContextStartedEvent

AbstractApplication#stop

* 调用LifecycleProcessor的stop方法
* 发布ContextStopedEvent

AbstractApplication#close

* 状态标识 closed--true  active--false

* MBean取消注册
* 发布ContextClosedEvent
* 调用LifecycleProcessor的onClose方法
* 销毁Spring Bean
* 关闭BeanFactory
* 回调onClose
* 注册Shutdown Hook线程